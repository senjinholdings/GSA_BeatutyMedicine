# mouthpiece002 チェックリスト

## 1. フォルダ構成と主要ファイル

- `index.html`
  - 画面本体。ランキング、比較表、Tips、詳細などを描画。
  - `<script src="app.js">` により機能を読み込み。
- `app.js`
  - 画面ロジックの中核。`DataManager` がデータを読み込み、各UIセクションを生成。
  - URLパラメータ（`region_id` など）を解釈して表示制御。
- `data/`
  - `clinic-texts.json`/`.csv`: クリニック別の文言・URL・画像パス・比較表ヘッダー設定など。
  - `site-common-texts.json`（存在すれば）: サイト共通テキストの上書き。
- `data copy/`（または `data/` 内の `compiled-data.json`）
  - `compiled-data.json`: 地域・クリニック・ランキング・店舗ビュー（`storeViews`）など統合JSON。
  - 生成元がCSVの場合は `create-compiled-data.js`（別ディレクトリ）の出力物。
- `redirect.html`
  - クリック後の中間ページ。`clinic_id`/`rank`/`region_id` から遷移先URLを決定し、パラメータを付与して公式サイトへ遷移。
- その他
  - `styles.css` ほかCSS群、`search-results/`、`sw.js` などの補助資材。

## 2. region_id による出し分けの流れ

1) URLパラメータ取得
- `app.js` で `new URLSearchParams(window.location.search)` を用い、`region_id` を取得。
- 取得できない場合は既定（例: `013` 東京）にフォールバック。

2) DataManager の初期化とデータ読込
- `DataManager.init()` 内で `compiled-data.json`（地域・ランキング・店舗ビュー）と `clinic-texts.json`（文言）を読み込む。
- 読み込み後に下記の配列に整形:
  - `regions`: `{ id, name }` の配列
  - `clinics`: `{ id, code, name, stores: [...] }` の配列
  - `rankings`: `[{ regionId, ranks }]`（ranksは `{ no1: "1", no2: "3", ... }` 形式）
  - `storeViews`: `[{ regionId, clinicStores }]`（clinicStoresは `code_stores: [storeId...]` など）

3) ランキングの取得（region_id → クリニックID）
- `getRankingByRegionId(regionId)` を呼び出し、対象地域の `ranks` を取得。
  - 実装上は `"013"` や `"13"` の両形式に対応するようにパディング/フォールバック検索。
- 例: `ranks.no1 === "1"` なら、1位の `clinicId=1` を取得。

4) クリニック情報の取得（clinicId → code/name → 文言）
- `getClinicCodeById(clinicId)` で `code`（例: `omt`, `kireil`, `ws`）を取得。
- 文言は `getClinicText(code, key, default)` で `clinic-texts.json` から取得。
  - 例: `総合評価`、`費用`、`特徴`、`クリニックロゴ画像パス`、`遷移先URL（1位）` など。

5) 店舗情報の出し分け（region_id → storeViews → 店舗ID群）
- `getStoresByRegionId(regionId)` で `storeViews` から該当地域の店舗ビューを取得。
- 取得済みランキング内の各クリニックについて、`clinic.code` をキーに `clinicStores[code_stores]` を参照し、表示対象の店舗IDリストを得る。
- 店舗IDから `stores`（`compiled-data.json` 由来）を引き、名称/住所/アクセス等を解決。

6) 画面反映
- ランキングカード、比較表、店舗一覧、ディテール等は、上記で取得した情報をもとに動的に生成。
- 公式リンクは `UrlParamHandler.getClinicUrlWithRegionId(clinicId, rank)` により `redirect.html?clinic_id=...&rank=...&region_id=...` を構築。

## 3. 主なAPI（メソッド）対応表（抜粋）

- `UrlParamHandler.getRegionId()`
  - URLから `region_id` を取得（なければ既定を返す）。
- `DataManager.getRankingByRegionId(regionId)`
  - 地域ごとの `ranks` を返す（`no1`〜）。ゼロ埋め/非ゼロ埋め両対応。
- `DataManager.getClinicCodeById(clinicId)`
  - クリニックID→コード（`omt` 等）を返す。
- `DataManager.getClinicText(clinicCode, key, default)`
  - `clinic-texts.json` から文言を取得。
- `DataManager.getStoresByRegionId(regionId)`
  - 地域ごとの店舗ビューを返し、ランキングに応じて各クリニックの表示店舗を解決。

## 4. チェック観点（抜粋）

- URLに `region_id` が存在し、意図した地域にフォールバックしているか
- 指定地域のランキング（no1〜）が、`compiled-data.json` の `rankings[region]` と一致しているか
- ランキングの各行の `clinicId` から `code` が正しく解決され、`clinic-texts.json` の文言が表示されているか
- 店舗一覧が `storeViews[region]` に基づく表示になっているか（別地域の店舗が混ざらない）
- 公式サイトリンクが `redirect.html?clinic_id=...&rank=...&region_id=...` 形式で正しく生成されるか
- `redirect.html` で `clinic_id/rank/region_id` を解釈し、`clinic-texts.json` の `遷移先URL（rank位）` に遷移できるか（param付与含む）

## 5. region_id トラブルシューティング・チェックリスト

1) URLパラメータの取得
- 確認: アドレスバーに `?region_id=013` などが付与されているか
- OK条件: 期待する `region_id` がセットされている／未指定時は既定（例: `013`）
- NG時対処: 内部リンクがパラメータを引き継ぐ実装か確認（`preserveAllParams` 相当の処理）

2) `UrlParamHandler.getRegionId()` の戻り値
- 確認: DevTools Console で `window.app?.urlHandler?.getRegionId()` を実行
- OK条件: 期待する `region_id` を返す
- NG時対処: 正規化/フォールバックの実装を確認（未指定時のデフォルト）

3) `compiled-data.json` のロード
- 確認: Network パネルで `data/compiled-data.json` の200応答／Consoleに読み込みエラーが出ていない
- OK条件: `regions/clinics/rankings/storeViews` が取得できている
- NG時対処: パス（`this.regionDataPath`）とファイル配置を確認。SW/キャッシュの影響も確認

4) `DataManager.init()` の完了
- 確認: Console に初期化ログ、例外なし／`window.app?.dataManager?.clinics.length > 0`
- OK条件: `regions`/`clinics`/`rankings`/`storeViews` が配列で保持されている
- NG時対処: 読み込み順や相対パスのズレ（`data/` vs `data copy/`）を修正

5) ランキングの解決 `getRankingByRegionId(regionId)`
- 確認: `window.app?.dataManager?.getRankingByRegionId('013')`
- OK条件: `ranks` オブジェクトが取得でき、`no1` 等が数値文字列で入っている
- NG時対処: `regionId` のゼロ埋め/非埋め両対応（`padStart(3,'0')` とフォールバック）を実装

6) クリニックID→コードの解決 `getClinicCodeById(clinicId)`
- 確認: 取得した `ranks.no1` を渡してコードが返るか
- OK条件: 例: `1 -> omt` のように `clinics` の対応が一致
- NG時対処: `clinics` の `id`/`code` の不整合を `compiled-data.json` 側で修正

7) クリニック文言の取得 `getClinicText(code, key)`
- 確認: `clinic-texts.json` の該当クリニック名の中にキーが存在するか（例: `総合評価/費用/特徴/遷移先URL（1位）`）
- OK条件: 値が返る（空でない）
- NG時対処: `code -> name` の解決が失敗していないか（`clinics[].name` とJSONキーの一致）

8) 店舗ビューの解決 `getStoresByRegionId(regionId)`
- 確認: 対象 `regionId` の `storeViews` が存在し、`{code}_stores` に配列が入っているか
- OK条件: ランキング内の各クリニックで1件以上の店舗IDが解決できる
- NG時対処: `store_view` データの作成ロジック（CSV→JSON）を再作成

9) MV/ランキングの地域名表示
- 確認: `#mv-region-name`/`#mv-region-text`/`#rank-region-name` などの文言が更新されるか
- OK条件: 取得した `region_id` に対応する `regions[].name` に更新
- NG時対処: 初期描画→更新の順序、非同期完了後にDOM更新しているか確認

10) 比較表・ランキングの表示
- 確認: 1〜5位の行が `rankings` に基づいて出力されているか
- OK条件: 1位ハイライト、評価/費用/特徴などがJSONの値と一致
- NG時対処: 列ヘッダー（`比較表ヘッダー設定`）と値キーの対応を点検

11) 公式サイトリンクの生成
- 確認: aタグ `href` が `redirect.html?clinic_id=..&rank=..&region_id=..`（またはハッシュ+localStorage）になっているか
- OK条件: 期待する `clinic_id`/`rank`/`region_id` が含まれる
- NG時対処: `UrlParamHandler.getClinicUrlWithRegionId()` の予約キー上書き防止/付け忘れを修正

12) `redirect.html` の受け取り
- 確認: Console で受け取った `clinic_id/rank/region_id` がログされ、`clinic-texts.json` の `遷移先URL（rank位）` が取れている
- OK条件: 取得URLへ遷移（paramの引き継ぎ含む）
- NG時対処: ハッシュ/クエリ/localStorage の3経路取得が全て失敗していないか、フォールバック動作を確認

13) キャッシュ/Service Worker の影響
- 確認: SW 有効時に旧 `compiled-data.json` を返していないか（DevToolsのDisable cache）
- OK条件: 最新データで上記すべてがOK
- NG時対処: SW停止/キャッシュ削除/クエリ版管理（`?v=`）で更新を強制

14) 404/ネットワークエラー
- 確認: Network に 404/403 がないか、相対パスの解決が正しいか
- OK条件: 依存ファイルが全て200
- NG時対処: `dataPath/regionDataPath` と実ファイル配置の整合を取る

15) ログ/例外の最終確認
- 確認: Consoleに未処理例外がない、警告は原因が把握済み
- OK条件: 画面機能（ランキング/比較表/店舗/リンク遷移）が地域に応じて正常
- NG時対処: 手順1へ戻る（URL/取得→データ→描画の順で再点検）
